<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="logo-container">
            <img src="pafenobg.png" alt="PAFE Logo" class="logo-img">
            <div class="company-title">PAFE</div>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-section="home"><i class="bi bi-house-door me-2"></i><span class="nav-text">Home</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="events"><i class="bi bi-calendar-event me-2"></i><span class="nav-text">Events</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="attendance"><i class="bi bi-person-check me-2"></i><span class="nav-text">Attendance</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="feedback"><i class="bi bi-chat-dots me-2"></i><span class="nav-text">Feedback</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="reports"><i class="bi bi-file-earmark-text me-2"></i><span class="nav-text">Generate Report</span></a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Header -->
        <header class="bg-white shadow-sm py-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-link text-dark" id="sidebarToggle">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-link text-dark dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle fs-4"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">Profile</a></li>
                            <li><a class="dropdown-item" href="#">Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="container-fluid p-4" id="content-area">
            <!-- Home Section -->
            <div id="home-section" class="content-section">
                <h1>Dashboard Overview</h1>
                <div class="row g-4 mt-3" id="dashboard-stats">
                    <!-- Stats cards will be populated here -->
                </div>
                <div class="mt-5">
                    <h2>Event Calendar</h2>
                    <div id="calendar" class="shadow-sm"></div>
                </div>
            </div>
            <!-- Events Section -->
            <div id="events-section" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                    <h1>Events</h1>
                    <button class="btn btn-primary mt-2 mt-md-0" data-bs-toggle="modal" data-bs-target="#eventModal" onclick="prepareCreateEvent()">Create Event</button>
                </div>
                <div class="mb-4 d-flex flex-wrap gap-3">
                    <div class="flex-fill" style="min-width: 200px;">
                        <label for="searchEvents" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchEvents" placeholder="Search by name or description">
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="sortEvents" class="form-label">Sort By</label>
                        <select class="form-select" id="sortEvents">
                            <option value="date-asc">Date (Ascending)</option>
                            <option value="date-desc">Date (Descending)</option>
                            <option value="status">Status</option>
                        </select>
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="filterStatus" class="form-label">Filter Status</label>
                        <select class="form-select" id="filterStatus">
                            <option value="all">All</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Ongoing">Ongoing</option>
                            <option value="Completed">Completed</option>
                            <option value="Canceled">Canceled</option>
                        </select>
                    </div>
                </div>
                <div id="events-list" class="row g-3">
                    <!-- Events will be dynamically populated here -->
                </div>
            </div>
            <!-- Attendance Section -->
            <div id="attendance-section" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                    <h1>Attendance</h1>
                    <button class="btn btn-primary mt-2 mt-md-0" data-bs-toggle="modal" data-bs-target="#attendanceModal">Mark Attendance</button>
                </div>
                <div class="mb-4 d-flex flex-wrap gap-3">
                    <div class="flex-fill" style="min-width: 200px;">
                        <label for="searchAttendance" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchAttendance" placeholder="Search by event or student name">
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="filterAttendanceStatus" class="form-label">Filter by Attendance Status</label>
                        <select class="form-select" id="filterAttendanceStatus">
                            <option value="all">All</option>
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                        </select>
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="filterEventStatus" class="form-label">Filter by Event Status</label>
                        <select class="form-select" id="filterEventStatus">
                            <option value="all">All</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Ongoing">Ongoing</option>
                            <option value="Completed">Completed</option>
                            <option value="Canceled">Canceled</option>
                        </select>
                    </div>
                </div>
                <div id="attendance-list">
                    <!-- Attendance records will be dynamically populated here -->
                </div>
            </div>
            <!-- Feedback Section -->
            <div id="feedback-section" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                    <h1>Feedback</h1>
                </div>
                <div class="mb-4 d-flex flex-wrap gap-3">
                    <div class="flex-fill" style="min-width: 200px;">
                        <label for="searchFeedback" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchFeedback" placeholder="Search by student name or feedback">
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="filterFeedbackEvent" class="form-label">Filter by Event</label>
                        <select class="form-select" id="filterFeedbackEvent">
                            <option value="all">All</option>
                            <!-- Events will be populated dynamically -->
                        </select>
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="sortFeedback" class="form-label">Sort By</label>
                        <select class="form-select" id="sortFeedback">
                            <option value="date-desc">Submission Date (Newest)</option>
                            <option value="date-asc">Submission Date (Oldest)</option>
                            <option value="student">Student Name</option>
                        </select>
                    </div>
                </div>
                <div id="feedback-list" class="row g-3">
                    <!-- Feedback records will be dynamically populated here -->
                </div>
            </div>
            <!-- Reports Section -->
            <div id="reports-section" class="content-section d-none">
                <h1 class="mb-4">Generate Report</h1>
                <div class="row g-4">
                    <!-- Report Generation Form -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center">
                                    <i class="bi bi-file-earmark-text me-2 text-primary"></i>
                                    Generate a New Report
                                </h5>
                                <div class="mt-3">
                                    <div class="mb-4">
                                        <label for="reportType" class="form-label fw-bold">Select Report Type</label>
                                        <select class="form-select" id="reportType">
                                            <option value="events">Events</option>
                                            <option value="attendance">Attendance</option>
                                            <option value="feedback">Feedback</option>
                                        </select>
                                    </div>
                                    <div class="mb-4 d-flex flex-wrap gap-3" id="reportFilters">
                                        <!-- Filters will be populated dynamically based on report type -->
                                    </div>
                                    <button class="btn btn-primary d-flex align-items-center" onclick="generateReport()">
                                        <i class="bi bi-file-earmark-arrow-down me-2"></i> Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Report Preview -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center">
                                    <i class="bi bi-table me-2 text-info"></i>
                                    Report Preview
                                </h5>
                                <div class="mt-3" id="report-preview">
                                    <p class="text-muted">Generate a report to see the preview here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal (for Create and Edit) -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Create New Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">
                        <div class="mb-3">
                            <label for="eventName" class="form-label">Event Name</label>
                            <input type="text" class="form-control" id="eventName" required>
                        </div>
                        <div class="mb-3">
                           [h for="eventDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="eventDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="eventTime" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventStatus" class="form-label">Status</label>
                            <select class="form-select" id="eventStatus" required>
                                <option value="Scheduled">Scheduled</option>
                                <option value="Ongoing">Ongoing</option>
                                <option value="Completed">Completed</option>
                                <option value="Canceled">Canceled</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="eventTotalStudents" class="form-label">Total Expected Students</label>
                            <input type="number" class="form-control" id="eventTotalStudents" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="eventDescription" rows="4"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" id="submitEventBtn">Create Event</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventDetailsModalLabel">Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="eventDetailsContent">
                    <!-- Event details will be dynamically populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editEventFromDetails" data-bs-toggle="modal" data-bs-target="#eventModal">Edit Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Modal (for Adding New Records) -->
    <div class="modal fade" id="attendanceModal" tabindex="-1" aria-labelledby="attendanceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attendanceModalLabel">Mark Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="attendanceForm">
                        <div class="mb-3">
                            <label for="attendanceEvent" class="form-label">Select Event</label>
                            <select class="form-select" id="attendanceEvent" required>
                                <option value="">Choose an event</option>
                                <!-- Events will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="attendanceStudents" class="form-label">Students (comma-separated)</label>
                            <input type="text" class="form-control" id="attendanceStudents" placeholder="e.g., John Doe, Jane Smith" required>
                        </div>
                        <div class="mb-3" id="attendanceStatusContainer">
                            <!-- Dynamically populated with student status dropdowns -->
                        </div>
                        <button type="submit" class="btn btn-primary">Save Attendance</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div class="modal fade" id="editAttendanceModal" tabindex="-1" aria-labelledby="editAttendanceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAttendanceModalLabel">Edit Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editAttendanceForm">
                        <input type="hidden" id="editAttendanceEventId">
                        <input type="hidden" id="editAttendanceStudentName">
                        <div class="mb-3">
                            <label for="editAttendanceStudent" class="form-label">Student Name</label>
                            <input type="text" class="form-control" id="editAttendanceStudent" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="editAttendanceStatus" class="form-label">Status</label>
                            <select class="form-select" id="editAttendanceStatus" required>
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                                <option value="Late">Late</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editAttendanceRecordedAt" class="form-label">Recorded At</label>
                            <input type="datetime-local" class="form-control" id="editAttendanceRecordedAt" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Details Modal -->
    <div class="modal fade" id="feedbackDetailsModal" tabindex="-1" aria-labelledby="feedbackDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackDetailsModalLabel">Feedback Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="feedbackDetailsContent">
                    <!-- Feedback details will be dynamically populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="deleteFeedbackBtn">Delete Feedback</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
        let calendar;

        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const sidebarToggle = document.getElementById('sidebarToggle');
        let isSidebarCollapsed = window.innerWidth <= 768;

        // Function to handle sidebar toggle
        function toggleSidebar() {
            isSidebarCollapsed = !isSidebarCollapsed;
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            sidebarToggle.classList.toggle('rotated');
            localStorage.setItem('sidebarCollapsed', isSidebarCollapsed);
            if (calendar) {
                calendar.render(); // Re-render calendar to adjust to new layout
            }
        }

        // Initialize sidebar state
        function initializeSidebar() {
            const savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true' || window.innerWidth <= 768) {
                isSidebarCollapsed = true;
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
                sidebarToggle.classList.add('rotated');
            } else {
                isSidebarCollapsed = false;
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
                sidebarToggle.classList.remove('rotated');
            }
            if (calendar) {
                calendar.render(); // Ensure calendar fits the initial layout
            }
        }

        // Sidebar navigation
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');

                // Update active nav link
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // Show corresponding section
                contentSections.forEach(s => s.classList.add('d-none'));
                document.getElementById(`${section}-section`).classList.remove('d-none');

                // Load content based on section
                if (section === 'home') {
                    loadDashboardStats();
                } else if (section === 'events') {
                    loadEvents();
                } else if (section === 'attendance') {
                    loadAttendance();
                } else if (section === 'feedback') {
                    loadFeedback();
                } else if (section === 'reports') {
                    initializeReportSection();
                }

                // Collapse sidebar on mobile after navigation
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            initializeSidebar();
        });

        // Initialize on page load
        initializeSidebar();

        // Function to load dashboard statistics and initialize calendar
        function loadDashboardStats() {
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const feedback = JSON.parse(localStorage.getItem('feedback') || '[]');
            const attendance = JSON.parse(localStorage.getItem('attendance') || '[]');

            const totalEvents = events.length;
            const totalFeedback = feedback.length;
            const totalAttendance = attendance.length;

            const statsContainer = document.getElementById('dashboard-stats');
            statsContainer.innerHTML = `
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar-event fs-2 me-3"></i>
                                <div>
                                    <h5 class="card-title">Total Events</h5>
                                    <p class="card-text fs-3">${totalEvents}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-chat-dots fs-2 me-3"></i>
                                <div>
                                    <h5 class="card-title">Total Feedback</h5>
                                    <p class="card-text fs-3">${totalFeedback}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="card text-white bg-info mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-check fs-2 me-3"></i>
                                <div>
                                    <h5 class="card-title">Total Attendance</h5>
                                    <p class="card-text fs-3">${totalAttendance}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initialize FullCalendar
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: window.innerWidth <= 576 ? 'listWeek' : 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                events: events.map(event => ({
                    id: event.id,
                    title: event.name,
                    start: `${event.date}T${event.time}`,
                    end: new Date(new Date(`${event.date}T${event.time}`).getTime() + 2 * 60 * 60 * 1000).toISOString(),
                    color: {
                        'Scheduled': '#007bff',
                        'Ongoing': '#28a745',
                        'Completed': '#6c757d',
                        'Canceled': '#dc3545'
                    }[event.status]
                })),
                eventClick: function(info) {
                    showEventDetails(info.event.id);
                    const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
                    modal.show();
                },
                height: 'auto',
                contentHeight: 'auto',
                aspectRatio: 1.35,
                views: {
                    dayGridMonth: { eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' } },
                    timeGridWeek: { eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' } },
                    listWeek: { eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' } }
                }
            });
            calendar.render();
        }

        // Event modal preparation for create
        function prepareCreateEvent() {
            document.getElementById('eventModalLabel').textContent = 'Create New Event';
            document.getElementById('submitEventBtn').textContent = 'Create Event';
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('eventStatus').value = 'Scheduled';
            document.getElementById('eventTotalStudents').value = '';
        }

        // Event modal preparation for edit
        function prepareEditEvent(eventId) {
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            document.getElementById('eventModalLabel').textContent = 'Edit Event';
            document.getElementById('submitEventBtn').textContent = 'Save Changes';
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventName').value = event.name;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventTime').value = event.time;
            document.getElementById('eventStatus').value = event.status;
            document.getElementById('eventTotalStudents').value = event.totalStudents || 0;
            document.getElementById('eventDescription').value = event.description || '';
        }

        // Event creation and editing
        const eventForm = document.getElementById('eventForm');
        eventForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const eventId = document.getElementById('eventId').value;
            const eventName = document.getElementById('eventName').value;
            const eventDate = document.getElementById('eventDate').value;
            const eventTime = document.getElementById('eventTime').value;
            const eventStatus = document.getElementById('eventStatus').value;
            const eventTotalStudents = parseInt(document.getElementById('eventTotalStudents').value) || 0;
            const eventDescription = document.getElementById('eventDescription').value;

            if (!eventName || !eventDate || !eventTime || !eventStatus || eventTotalStudents < 0) {
                alert('Please fill in all required fields and ensure total students is non-negative.');
                return;
            }

            let events = JSON.parse(localStorage.getItem('events') || '[]');
            const event = {
                id: eventId ? parseInt(eventId) : Date.now(),
                name: eventName,
                date: eventDate,
                time: eventTime,
                status: eventStatus,
                totalStudents: eventTotalStudents,
                description: eventDescription,
                createdAt: eventId ? events.find(e => e.id === parseInt(eventId))?.createdAt : new Date().toISOString()
            };

            if (eventId) {
                events = events.map(e => e.id === parseInt(eventId) ? event : e);
            } else {
                events.push(event);
            }

            localStorage.setItem('events', JSON.stringify(events));
            eventForm.reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
            modal.hide();
            loadEvents();
            loadDashboardStats();
            alert(eventId ? 'Event updated successfully!' : 'Event created successfully!');
        });

        // Event deletion
        function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) return;

            let events = JSON.parse(localStorage.getItem('events') || '[]');
            events = events.filter(e => e.id !== eventId);
            localStorage.setItem('events', JSON.stringify(events));

            let attendanceRecords = JSON.parse(localStorage.getItem('attendance') || '[]');
            attendanceRecords = attendanceRecords.filter(record => record.eventId !== eventId);
            localStorage.setItem('attendance', JSON.stringify(attendanceRecords));

            let feedbackRecords = JSON.parse(localStorage.getItem('feedback') || '[]');
            feedbackRecords = feedbackRecords.filter(record => record.eventId !== eventId);
            localStorage.setItem('feedback', JSON.stringify(feedbackRecords));

            loadEvents();
            loadAttendance();
            loadFeedback();
            loadDashboardStats();
            alert('Event and associated records deleted successfully!');
        }

        // Show event details
        function showEventDetails(eventId) {
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const event = events.find(e => e.id === parseInt(eventId));
            if (!event) {
                document.getElementById('eventDetailsContent').innerHTML = `
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i> Event not found.
                    </div>
                `;
                document.getElementById('editEventFromDetails').style.display = 'none';
                return;
            }

            const statusBadgeClass = {
                'Scheduled': 'bg-primary',
                'Ongoing': 'bg-success',
                'Completed': 'bg-secondary',
                'Canceled': 'bg-danger'
            }[event.status];

            const startDateTime = new Date(`${event.date}T${event.time}`);
            const endDateTime = new Date(startDateTime.getTime() + 2 * 60 * 60 * 1000);
            const formattedTime = startDateTime.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            const formattedEndTime = endDateTime.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

            const detailsContent = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">${event.name}</h5>
                        <p class="card-text"><strong>Date:</strong> ${event.date}</p>
                        <p class="card-text"><strong>Time:</strong> ${formattedTime} - ${formattedEndTime}</p>
                        <p class="card-text"><strong>Status:</strong> <span class="badge ${statusBadgeClass}">${event.status}</span></p>
                        <p class="card-text"><strong>Total Expected Students:</strong> ${event.totalStudents}</p>
                        <p class="card-text"><strong>Description:</strong> ${event.description || 'No description'}</p>
                        <p class="card-text"><strong>Created At:</strong> ${new Date(event.createdAt).toLocaleString()}</p>
                    </div>
                </div>
            `;
            document.getElementById('eventDetailsContent').innerHTML = detailsContent;
            document.getElementById('editEventFromDetails').style.display = 'block';
            document.getElementById('editEventFromDetails').onclick = () => prepareEditEvent(eventId);
        }

        // Auto-update event status
        function updateEventStatuses() {
            const now = new Date();
            let events = JSON.parse(localStorage.getItem('events') || '[]');
            let updated = false;

            events = events.map(event => {
                const eventDateTime = new Date(`${event.date}T${event.time}`);
                const eventEndTime = new Date(eventDateTime.getTime() + 2 * 60 * 60 * 1000);
                let newStatus = event.status;

                if (event.status !== 'Canceled') {
                    if (now > eventEndTime) {
                        newStatus = 'Completed';
                    } else if (now >= eventDateTime && now <= eventEndTime) {
                        newStatus = 'Ongoing';
                    } else if (now < eventDateTime) {
                        newStatus = 'Scheduled';
                    }
                }

                if (newStatus !== event.status) {
                    updated = true;
                    return { ...event, status: newStatus };
                }
                return event;
            });

            if (updated) {
                localStorage.setItem('events', JSON.stringify(events));
            }
            return events;
        }

        // Load and display events
        function loadEvents() {
            const eventsList = document.getElementById('events-list');
            const searchQuery = document.getElementById('searchEvents').value.toLowerCase();
            const sortOption = document.getElementById('sortEvents').value;
            const filterStatus = document.getElementById('filterStatus').value;

            let events = updateEventStatuses();

            if (searchQuery) {
                events = events.filter(event =>
                    event.name.toLowerCase().includes(searchQuery) ||
                    (event.description && event.description.toLowerCase().includes(searchQuery))
                );
            }

            if (filterStatus !== 'all') {
                events = events.filter(event => event.status === filterStatus);
            }

            events.sort((a, b) => {
                if (sortOption === 'date-asc') {
                    return new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`);
                } else if (sortOption === 'date-desc') {
                    return new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`);
                } else if (sortOption === 'status') {
                    return a.status.localeCompare(b.status);
                }
                return 0;
            });

            eventsList.innerHTML = '';

            if (events.length === 0) {
                eventsList.innerHTML = '<p class="col-12">No events match the current filters.</p>';
                return;
            }

            events.forEach(event => {
                const statusBadgeClass = {
                    'Scheduled': 'bg-primary',
                    'Ongoing': 'bg-success',
                    'Completed': 'bg-secondary',
                    'Canceled': 'bg-danger'
                }[event.status];

                const eventCard = `
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#eventDetailsModal" onclick="showEventDetails(${event.id})">
                            <div class="card-body">
                                <h5 class="card-title">${event.name}</h5>
                                <p class="card-text"><strong>Date:</strong> ${event.date}</p>
                                <p class="card-text"><strong>Time:</strong> ${event.time}</p>
                                <p class="card-text"><strong>Status:</strong> <span class="badge ${statusBadgeClass}">${event.status}</span></p>
                                <p class="card-text"><strong>Total Expected Students:</strong> ${event.totalStudents}</p>
                                <p class="card-text"><strong>Description:</strong> ${event.description || 'No description'}</p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#eventModal" onclick="event.stopPropagation(); prepareEditEvent(${event.id})">Edit</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteEvent(${event.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                eventsList.innerHTML += eventCard;
            });

            // Update calendar
            if (calendar) {
                calendar.getEvents().forEach(event => event.remove());
                events.forEach(event => {
                    calendar.addEvent({
                        id: event.id,
                        title: event.name,
                        start: `${event.date}T${event.time}`,
                        end: new Date(new Date(`${event.date}T${event.time}`).getTime() + 2 * 60 * 60 * 1000).toISOString(),
                        color: {
                            'Scheduled': '#007bff',
                            'Ongoing': '#28a745',
                            'Completed': '#6c757d',
                            'Canceled': '#dc3545'
                        }[event.status]
                    });
                });
                calendar.render();
            }
        }

        // Event listeners for search, sort, and filter
        document.getElementById('searchEvents').addEventListener('input', loadEvents);
        document.getElementById('sortEvents').addEventListener('change', loadEvents);
        document.getElementById('filterStatus').addEventListener('change', loadEvents);

        // Populate events in attendance modal
        function populateAttendanceEvents() {
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const attendanceEventSelect = document.getElementById('attendanceEvent');
            attendanceEventSelect.innerHTML = '<option value="">Choose an event</option>';

            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = `${event.name} (${event.date} ${event.time})`;
                attendanceEventSelect.appendChild(option);
            });
        }

        // Update attendance status dropdowns dynamically
        document.getElementById('attendanceStudents').addEventListener('input', function() {
            const studentsInput = this.value;
            const students = studentsInput.split(',').map(s => s.trim()).filter(s => s);
            const statusContainer = document.getElementById('attendanceStatusContainer');
            statusContainer.innerHTML = '';

            students.forEach(student => {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `
                    <label class="form-label">${student}</label>
                    <select class="form-select" name="status-${student}" required>
                        <option value="Present">Present</option>
                        <option value="Absent">Absent</option>
                        <option value="Late">Late</option>
                    </select>
                `;
                statusContainer.appendChild(div);
            });
        });

        // Attendance modal setup
        document.getElementById('attendanceModal').addEventListener('show.bs.modal', function() {
            populateAttendanceEvents();
            document.getElementById('attendanceForm').reset();
            document.getElementById('attendanceStatusContainer').innerHTML = '';
        });

        // Attendance form submission
        const attendanceForm = document.getElementById('attendanceForm');
        attendanceForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const eventId = parseInt(document.getElementById('attendanceEvent').value);
            const studentsInput = document.getElementById('attendanceStudents').value;
            const students = studentsInput.split(',').map(s => s.trim()).filter(s => s);

            if (!eventId || students.length === 0) {
                alert('Please select an event and enter at least one student.');
                return;
            }

            let existingRecords = JSON.parse(localStorage.getItem('attendance') || '[]');
            const eventRecords = existingRecords.filter(record => record.eventId === eventId);
            const existingStudentNames = new Set(eventRecords.map(record => record.studentName.toLowerCase()));

            const newRecords = [];
            const duplicates = [];

            students.forEach(student => {
                if (existingStudentNames.has(student.toLowerCase())) {
                    duplicates.push(student);
                } else {
                    newRecords.push({
                        eventId: eventId,
                        studentName: student,
                        status: document.querySelector(`select[name="status-${student}"]`).value,
                        recordedAt: new Date().toISOString()
                    });
                    existingStudentNames.add(student.toLowerCase());
                }
            });

            if (newRecords.length === 0) {
                alert('All entered students are already recorded for this event.');
                return;
            }

            existingRecords.push(...newRecords);
            localStorage.setItem('attendance', JSON.stringify(existingRecords));

            document.getEdition('attendanceForm').reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('attendanceModal'));
            modal.hide();

            loadAttendance();
            loadDashboardStats();

            let message = `Attendance recorded for ${newRecords.length} student(s).`;
            if (duplicates.length > 0) {
                message += `\nSkipped duplicates: ${duplicates.join(', ')}.`;
            }
            alert(message);
        });

        // Prepare edit attendance modal
        function prepareEditAttendance(eventId, studentName) {
            const attendanceRecords = JSON.parse(localStorage.getItem('attendance') || '[]');
            const record = attendanceRecords.find(r => r.eventId === eventId && r.studentName === studentName);
            if (!record) return;

            document.getElementById('editAttendanceEventId').value = eventId;
            document.getElementById('editAttendanceStudentName').value = studentName;
            document.getElementById('editAttendanceStudent').value = studentName;
            document.getElementById('editAttendanceStatus').value = record.status;
            document.getElementById('editAttendanceRecordedAt').value = new Date(record.recordedAt).toISOString().slice(0, 16);
        }

        // Edit attendance form submission
        const editAttendanceForm = document.getElementById('editAttendanceForm');
        editAttendanceForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const eventId = parseInt(document.getElementById('editAttendanceEventId').value);
            const studentName = document.getElementById('editAttendanceStudentName').value;
            const status = document.getElementById('editAttendanceStatus').value;
            const recordedAt = new Date(document.getElementById('editAttendanceRecordedAt').value).toISOString();

            let attendanceRecords = JSON.parse(localStorage.getItem('attendance') || '[]');
            attendanceRecords = attendanceRecords.map(record => {
                if (record.eventId === eventId && record.studentName === studentName) {
                    return { ...record, status, recordedAt };
                }
                return record;
            });

            localStorage.setItem('attendance', JSON.stringify(attendanceRecords));

            const modal = bootstrap.Modal.getInstance(document.getElementById('editAttendanceModal'));
            modal.hide();

            loadAttendance();
            loadDashboardStats();
            alert(`Attendance updated for ${studentName}.`);
        });

        // Delete attendance record
        function deleteAttendanceRecord(eventId, studentName) {
            if (!confirm(`Are you sure you want to delete the attendance record for ${studentName}?`)) return;

            let attendanceRecords = JSON.parse(localStorage.getItem('attendance') || '[]');
            attendanceRecords = attendanceRecords.filter(record => !(record.eventId === eventId && record.studentName === studentName));
            localStorage.setItem('attendance', JSON.stringify(attendanceRecords));

            loadAttendance();
            loadDashboardStats();
            alert(`Attendance record for ${studentName} deleted successfully.`);
        }

        // Export attendance to CSV
        function exportAttendanceToCSV(eventId) {
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const attendanceRecords = JSON.parse(localStorage.getItem('attendance') || '[]');
            const eventRecords = attendanceRecords.filter(record => record.eventId === eventId);

            const headers = ['Event Name', 'Date', 'Time', 'Student Name', 'Status', 'Recorded At'];
            const rows = eventRecords.map(record => [
                `"${event.name.replace(/"/g, '""')}"`,
                event.date,
                event.time,
                `"${record.studentName.replace(/"/g, '""')}"`,
                record.status,
                new Date(record.recordedAt).toLocaleString()
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${event.name}_attendance.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load and display attendance records
        function loadAttendance() {
            const attendanceList = document.getElementById('attendance-list');
            const searchQuery = document.getElementById('searchAttendance').value.toLowerCase();
            const filterAttendanceStatus = document.getElementById('filterAttendanceStatus').value;
            const filterEventStatus = document.getElementById('filterEventStatus').value;

            let events = JSON.parse(localStorage.getItem('events') || '[]');
            const attendanceRecords = JSON.parse(localStorage.getItem('attendance') || '[]');

            events = events.filter(event => {
                const matchesSearch = searchQuery === '' ||
                    event.name.toLowerCase().includes(searchQuery) ||
                    attendanceRecords.some(record => record.eventId === event.id && record.studentName.toLowerCase().includes(searchQuery));
                const matchesEventStatus = filterEventStatus === 'all' || event.status === filterEventStatus;
                return matchesSearch && matchesEventStatus;
            });

            attendanceList.innerHTML = '';

            if (events.length === 0) {
                attendanceList.innerHTML = '<p>No events match the current filters.</p>';
                return;
            }

            events.forEach(event => {
                let eventRecords = attendanceRecords.filter(record => record.eventId === event.id);

                if (filterAttendanceStatus !== 'all') {
                    eventRecords = eventRecords.filter(record => record.status === filterAttendanceStatus);
                }

                const recordedCount = eventRecords.length;
                const totalExpected = event.totalStudents || 0;
                let tableRows = '';

                if (eventRecords.length === 0) {
                    tableRows = '<tr><td colspan="4" class="text-center">No attendance records match the current filters.</td></tr>';
                } else {
                    tableRows = eventRecords.map(record => `
                        <tr>
                            <td>${record.studentName}</td>
                            <td>${record.status}</td>
                            <td>${new Date(record.recordedAt).toLocaleString()}</td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editAttendanceModal" onclick="prepareEditAttendance(${event.id}, '${record.studentName.replace(/'/g, "\\'")}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAttendanceRecord(${event.id}, '${record.studentName.replace(/'/g, "\\'")}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }

                const eventCard = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">${event.name}</h5>
                            <p class="card-text"><strong>Date:</strong> ${event.date}</p>
                            <p class="card-text"><strong>Time:</strong> ${event.time}</p>
                            <p class="card-text"><strong>Attendance Recorded:</strong> ${recordedCount}/${totalExpected}</p>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Student Name</th>
                                            <th>Status</th>
                                            <th>Recorded At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#attendanceModal" onclick="preselectEvent(${event.id})">Mark Attendance</button>
                                <button class="btn btn-sm btn-outline-success" onclick="exportAttendanceToCSV(${event.id})">Export to CSV</button>
                            </div>
                        </div>
                    </div>
                `;
                attendanceList.innerHTML += eventCard;
            });
        }

        // Preselect event in attendance modal
        function preselectEvent(eventId) {
            populateAttendanceEvents();
            document.getElementById('attendanceEvent').value = eventId;
            document.getElementById('attendanceStudents').value = '';
            document.getElementById('attendanceStatusContainer').innerHTML = '';
        }

        // Populate events in feedback filter
        function populateFeedbackEvents() {
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const feedbackEventSelect = document.getElementById('filterFeedbackEvent');
            feedbackEventSelect.innerHTML = '<option value="all">All</option><option value="none">No Event</option>';

            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = `${event.name} (${event.date} ${event.time})`;
                feedbackEventSelect.appendChild(option);
            });
        }

        // Show feedback details
        function showFeedbackDetails(feedbackId) {
            const feedbackRecords = JSON.parse(localStorage.getItem('feedback') || '[]');
            const feedback = feedbackRecords.find(f => f.id === feedbackId);
            if (!feedback) return;

            const events = JSON.parse(localStorage.getItem('events') || '[]');
            const event = feedback.eventId ? events.find(e => e.id === feedback.eventId) : null;

            const detailsContent = `
                <h5>Feedback from ${feedback.studentName}</h5>
                <p><strong>Event:</strong> ${event ? `${event.name} (${event.date} ${event.time})` : 'No Event'}</p>
                <p><strong>Feedback:</strong> ${feedback.message}</p>
                <p><strong>Submitted At:</strong> ${new Date(feedback.submittedAt).toLocaleString()}</p>
            `;
            document.getElementById('feedbackDetailsContent').innerHTML = detailsContent;
            document.getElementById('deleteFeedbackBtn').onclick = () => deleteFeedback(feedbackId);
        }

        // Delete feedback
        function deleteFeedback(feedbackId) {
            if (!confirm('Are you sure you want to delete this feedback?')) return;

            let feedbackRecords = JSON.parse(localStorage.getItem('feedback') || '[]');
            feedbackRecords = feedbackRecords.filter(f => f.id !== feedbackId);
            localStorage.setItem('feedback', JSON.stringify(feedbackRecords));

            loadFeedback();
            loadDashboardStats();
            const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackDetailsModal'));
            modal.hide();
            alert('Feedback deleted successfully!');
        }

        // Load and display feedback
        function loadFeedback() {
            const feedbackList = document.getElementById('feedback-list');
            const searchQuery = document.getElementById('searchFeedback').value.toLowerCase();
            const filterEvent = document.getElementById('filterFeedbackEvent').value;
            const sortOption = document.getElementById('sortFeedback').value;

            const feedbackRecords = JSON.parse(localStorage.getItem('feedback') || '[]');
            const events = JSON.parse(localStorage.getItem('events') || '[]');

            let filteredFeedback = feedbackRecords;

            if (searchQuery) {
                filteredFeedback = filteredFeedback.filter(f =>
                    f.studentName.toLowerCase().includes(searchQuery) ||
                    f.message.toLowerCase().includes(searchQuery)
                );
            }

            if (filterEvent !== 'all') {
                if (filterEvent === 'none') {
                    filteredFeedback = filteredFeedback.filter(f => !f.eventId);
                } else {
                    filteredFeedback = filteredFeedback.filter(f => f.eventId === parseInt(filterEvent));
                }
            }

            filteredFeedback.sort((a, b) => {
                if (sortOption === 'date-asc') {
                    return new Date(a.submittedAt) - new Date(b.submittedAt);
                } else if (sortOption === 'date-desc') {
                    return new Date(b.submittedAt) - new Date(a.submittedAt);
                } else if (sortOption === 'student') {
                    return a.studentName.localeCompare(b.studentName);
                }
                return 0;
            });

            feedbackList.innerHTML = '';

            if (filteredFeedback.length === 0) {
                feedbackList.innerHTML = '<p class="col-12">No feedback matches the current filters.</p>';
                return;
            }

            filteredFeedback.forEach(feedback => {
                const event = feedback.eventId ? events.find(e => e.id === feedback.eventId) : null;
                const feedbackCard = `
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#feedbackDetailsModal" onclick="showFeedbackDetails(${feedback.id})">
                            <div class="card-body">
                                <h5 class="card-title">${feedback.studentName}</h5>
                                <p class="card-text"><strong>Event:</strong> ${event ? `${event.name} (${event.date})` : 'No Event'}</p>
                                <p class="card-text"><strong>Feedback:</strong> ${feedback.message.length > 100 ? feedback.message.substring(0, 100) + '...' : feedback.message}</p>
                                <p class="card-text"><strong>Submitted At:</strong> ${new Date(feedback.submittedAt).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                `;
                feedbackList.innerHTML += feedbackCard;
            });

            populateFeedbackEvents();
        }

        //zionEventListeners('searchFeedback').addEventListener('input', loadFeedback);
        document.getElementById('filterFeedbackEvent').addEventListener('change', loadFeedback);
        document.getElementById('sortFeedback').addEventListener('change', loadFeedback);

        // Function to add feedback (for testing purposes)
        function addFeedback(studentName, message, eventId = null) {
            let feedbackRecords = JSON.parse(localStorage.getItem('feedback') || '[]');
            const feedback = {
                id: Date.now(),
                studentName,
                message,
                eventId: eventId ? parseInt(eventId) : null,
                submittedAt: new Date().toISOString()
            };
            feedbackRecords.push(feedback);
            localStorage.setItem('feedback', JSON.stringify(feedbackRecords));
            loadFeedback();
            loadDashboardStats();
        }

        // Initialize report section
        function initializeReportSection() {
            const reportTypeSelect = document.getElementById('reportType');
            reportTypeSelect.addEventListener('change', updateReportFilters);
            updateReportFilters();
        }

        // Update report filters based on report type
        function updateReportFilters() {
            const reportType = document.getElementById('reportType').value;
            const reportFilters = document.getElementById('reportFilters');
            reportFilters.innerHTML = '';

            if (reportType === 'events') {
                reportFilters.innerHTML = `
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="reportEventStatus" class="form-label fw-bold">Filter Status</label>
                        <select class="form-select" id="reportEventStatus">
                            <option value="all">All</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Ongoing">Ongoing</option>
                            <option value="Completed">Completed</option>
                            <option value="Canceled">Canceled</option>
                        </select>
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="reportEventDateFrom" class="form-label fw-bold">Date From</label>
                        <input type="date" class="form-control" id="reportEventDateFrom">
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="reportEventDateTo" class="form-label fw-bold">Date To</label>
                        <input type="date" class="form-control" id="reportEventDateTo">
                    </div>
                `;
            } else if (reportType === 'attendance') {
                reportFilters.innerHTML = `
                    <div class="flex-fill" style="min-width: 200px;">
                        <label for="reportAttendanceEvent" class="form-label fw-bold">Select Event</label>
                        <select class="form-select" id="reportAttendanceEvent">
                            <option value="all">All Events</option>
                            ${JSON.parse(localStorage.getItem('events') || '[]').map(event => 
                                `<option value="${event.id}">${event.name} (${event.date} ${event.time})</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="reportAttendanceStatus" class="form-label fw-bold">Attendance Status</label>
                        <select class="form-select" id="reportAttendanceStatus">
                            <option value="all">All</option>
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                        </select>
                    </div>
                `;
            } else if (reportType === 'feedback') {
                reportFilters.innerHTML = `
                    <div class="flex-fill" style="min-width: 200px;">
                        <label for="reportFeedbackEvent" class="form-label fw-bold">Select Event</label>
                        <select class="form-select" id="reportFeedbackEvent">
                            <option value="all">All</option>
                            <option value="none">No Event</option>
                            ${JSON.parse(localStorage.getItem('events') || '[]').map(event => 
                                `<option value="${event.id}">${event.name} (${event.date} ${event.time})</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="reportFeedbackDateFrom" class="form-label fw-bold">Submission Date From</label>
                        <input type="date" class="form-control" id="reportFeedbackDateFrom">
                    </div>
                    <div class="flex-fill" style="min-width: 150px;">
                        <label for="reportFeedbackDateTo" class="form-label fw-bold">Submission Date To</label>
                        <input type="date" class="form-control" id="reportFeedbackDateTo">
                    </div>
                `;
            }
        }

        // Generate and display report
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportPreview = document.getElementById('report-preview');
            let csvContent = '';
            let filename = '';

            if (reportType === 'events') {
                const statusFilter = document.getElementById('reportEventStatus')?.value;
                const dateFrom = document.getElementById('reportEventDateFrom')?.value;
                const dateTo = document.getElementById('reportEventDateTo')?.value;

                let events = JSON.parse(localStorage.getItem('events') || '[]');

                if (statusFilter !== 'all') {
                    events = events.filter(event => event.status === statusFilter);
                }
                if (dateFrom) {
                    events = events.filter(event => event.date >= dateFrom);
                }
                if (dateTo) {
                    events = events.filter(event => event.date <= dateTo);
                }

                const headers = ['ID', 'Name', 'Date', 'Time', 'Status', 'Total Students', 'Description', 'Created At'];
                const rows = events.map(event => [
                    event.id,
                    `"${event.name.replace(/"/g, '""')}"`,
                    event.date,
                    event.time,
                    event.status,
                    event.totalStudents,
                    `"${event.description ? event.description.replace(/"/g, '""') : 'No description'}"`,
                    new Date(event.createdAt).toLocaleString()
                ]);

                reportPreview.innerHTML = `
                    <h3 class="mb-3">Events Report</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${rows.length ? rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('') : '<tr><td colspan="8" class="text-center">No events match the filters.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-success d-flex align-items-center mt-3" onclick="downloadReport('events_report.csv', \`${[
                        headers.join(','),
                        ...rows.map(row => row.join(','))
                    ].join('\n')}\`)">
                        <i class="bi bi-download me-2"></i> Download CSV
                    </button>
                `;
                filename = 'events_report.csv';
                csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            } else if (reportType === 'attendance') {
                const eventFilter = document.getElementById('reportAttendanceEvent')?.value;
                const statusFilter = document.getElementById('reportAttendanceStatus')?.value;

                const events = JSON.parse(localStorage.getItem('events') || '[]');
                let attendanceRecords = JSON.parse(localStorage.getItem('attendance') || '[]');

                if (eventFilter !== 'all') {
                    attendanceRecords = attendanceRecords.filter(record => record.eventId === parseInt(eventFilter));
                }
                if (statusFilter !== 'all') {
                    attendanceRecords = attendanceRecords.filter(record => record.status === statusFilter);
                }

                const headers = ['Event Name', 'Event Date', 'Event Time', 'Student Name', 'Status', 'Recorded At'];
                const rows = attendanceRecords.map(record => {
                    const event = events.find(e => e.id === record.eventId) || { name: 'Unknown Event', date: '', time: '' };
                    return [
                        `"${event.name.replace(/"/g, '""')}"`,
                        event.date,
                        event.time,
                        `"${record.studentName.replace(/"/g, '""')}"`,
                        record.status,
                        new Date(record.recordedAt).toLocaleString()
                    ];
                });

                reportPreview.innerHTML = `
                    <h3 class="mb-3">Attendance Report</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${rows.length ? rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('') : '<tr><td colspan="6" class="text-center">No attendance records match the filters.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-success d-flex align-items-center mt-3" onclick="downloadReport('attendance_report.csv', \`${[
                        headers.join(','),
                        ...rows.map(row => row.join(','))
                    ].join('\n')}\`)">
                        <i class="bi bi-download me-2"></i> Download CSV
                    </button>
                `;
                filename = 'attendance_report.csv';
                csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            } else if (reportType === 'feedback') {
                const eventFilter = document.getElementById('reportFeedbackEvent')?.value;
                const dateFrom = document.getElementById('reportFeedbackDateFrom')?.value;
                const dateTo = document.getElementById('reportFeedbackDateTo')?.value;

                const events = JSON.parse(localStorage.getItem('events') || '[]');
                let feedbackRecords = JSON.parse(localStorage.getItem('feedback') || '[]');

                if (eventFilter !== 'all') {
                    if (eventFilter === 'none') {
                        feedbackRecords = feedbackRecords.filter(f => !f.eventId);
                    } else {
                        feedbackRecords = feedbackRecords.filter(f => f.eventId === parseInt(eventFilter));
                    }
                }
                if (dateFrom) {
                    feedbackRecords = feedbackRecords.filter(f => new Date(f.submittedAt) >= new Date(dateFrom));
                }
                if (dateTo) {
                    feedbackRecords = feedbackRecords.filter(f => new Date(f.submittedAt) <= new Date(dateTo));
                }

                const headers = ['Student Name', 'Event Name', 'Feedback', 'Submitted At'];
                const rows = feedbackRecords.map(feedback => {
                    const event = feedback.eventId ? events.find(e => e.id === feedback.eventId) : null;
                    return [
                        `"${feedback.studentName.replace(/"/g, '""')}"`,
                        `"${event ? event.name.replace(/"/g, '""') : 'No Event'}"`,
                        `"${feedback.message.replace(/"/g, '""')}"`,
                        new Date(feedback.submittedAt).toLocaleString()
                    ];
                });

                reportPreview.innerHTML = `
                    <h3 class="mb-3">Feedback Report</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${rows.length ? rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('') : '<tr><td colspan="4" class="text-center">No feedback records match the filters.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-success d-flex align-items-center mt-3" onclick="downloadReport('feedback_report.csv', \`${[
                        headers.join(','),
                        ...rows.map(row => row.join(','))
                    ].join('\n')}\`)">
                        <i class="bi bi-download me-2"></i> Download CSV
                    </button>
                `;
                filename = 'feedback_report.csv';
                csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            }
        }

        // Download report as CSV
        function downloadReport(filename, csvContent) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load home section and dashboard stats by default
        document.getElementById('home-section').classList.remove('d-none');
        loadDashboardStats();

        // Initialize sidebar toggle event
        sidebarToggle.addEventListener('click', toggleSidebar);

        // Add sample feedback for testing (remove in production)
        if (!localStorage.getItem('feedback')) {
            addFeedback('John Doe', 'Great event, very informative!', null);
            addFeedback('Jane Smith', 'The workshop was well-organized.', 1);
        }
    </script>
</body>
</html>